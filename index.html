<!DOCTYPE html>
<html class="h-full">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tag {
      @apply px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-md mx-auto">
    <h1 class="text-2xl font-bold mb-4">AIé”™é¢˜æœ¬</h1>
    
    <!-- ä¸Šä¼ æŒ‰é’® -->
    <label class="block w-full p-4 bg-white rounded-lg shadow-md text-center cursor-pointer">
      <input type="file" id="upload" accept="image/*" class="hidden">
      <span class="text-blue-500">ğŸ“· æ‹ç…§/ä¸Šä¼ é¢˜ç›®</span>
    </label>

    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div id="preview" class="mt-4 w-full h-64 bg-white rounded-lg shadow-md bg-center bg-no-repeat bg-cover"></div>

    <!-- çŸ¥è¯†ç‚¹æ ‡ç­¾å®¹å™¨ -->
    <div id="tags" class="mt-4 flex flex-wrap gap-2"></div>

    <!-- åˆ†æè¿›åº¦æ¡ -->
    <div id="progress" class="mt-4 h-2 bg-gray-200 rounded hidden">
      <div class="h-full bg-blue-500 rounded" style="width: 0%"></div>
    </div>

    <!-- ä¿å­˜çŠ¶æ€æç¤º -->
    <div id="save-status" class="mt-4 text-sm text-gray-600"></div>
  </div>

  <script>
    // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
    const supabase = createClient(
      'YOUR_SUPABASE_URL', // æ›¿æ¢ä¸ºä½ çš„Supabaseé¡¹ç›®URL
      'YOUR_SUPABASE_KEY'  // æ›¿æ¢ä¸ºä½ çš„Supabase API Key
    )

    // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
    document.getElementById('upload').addEventListener('change', async function(e) {
      const file = e.target.files[0]
      const reader = new FileReader()

      reader.onload = async function() {
        const base64 = reader.result.split(',')[1]
        document.getElementById('preview').style.backgroundImage = `url(${reader.result})`

        // è°ƒç”¨åˆ†æ
        const result = await analyzeImage(base64)
        if (result) {
          displayAnalysis(result)
          saveToDatabase(result, file)
        }
      }

      reader.readAsDataURL(file)
    })

    // è°ƒç”¨DeepSeek APIåˆ†æå›¾ç‰‡
    async function analyzeImage(imageBase64) {
      // æ˜¾ç¤ºè¿›åº¦æ¡
      document.getElementById('progress').classList.remove('hidden')
      updateProgress(30)

      try {
        const response = await fetch('https://api.deepseek.com/v1/vision', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer YOUR_DEEPSEEK_API_KEY`, // æ›¿æ¢ä¸ºä½ çš„API Key
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image: imageBase64,
            features: ['text', 'math_formula', 'knowledge_points']
          })
        })

        updateProgress(70)
        const result = await response.json()
        return result
      } catch (error) {
        console.error('åˆ†æå¤±è´¥:', error)
        return null
      } finally {
        updateProgress(100)
      }
    }

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(percent) {
      document.querySelector('#progress > div').style.width = `${percent}%`
    }

    // æ˜¾ç¤ºåˆ†æç»“æœ
    function displayAnalysis(result) {
      const tagsContainer = document.getElementById('tags')
      tagsContainer.innerHTML = '' // æ¸…ç©ºåŸæœ‰å†…å®¹

      result.knowledge_points.forEach(tag => {
        const tagElement = document.createElement('div')
        tagElement.className = 'tag'
        tagElement.textContent = tag
        tagsContainer.appendChild(tagElement)
      })

      document.getElementById('result').textContent = 
        `åˆ†æå®Œæˆï¼è¯†åˆ«åˆ°${result.knowledge_points.length}ä¸ªçŸ¥è¯†ç‚¹`
    }

    // ä¿å­˜åˆ°æ•°æ®åº“
    async function saveToDatabase(analysis, imageFile) {
      // ä¸Šä¼ å›¾ç‰‡
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('question-images')
        .upload(`${Date.now()}.jpg`, imageFile)

      if (uploadError) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', uploadError)
        document.getElementById('save-status').textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'
        return
      }

      // ä¿å­˜åˆ†æç»“æœ
      const { data: insertData, error: insertError } = await supabase
        .from('questions')
        .insert({
          image_url: uploadData.path,
          analysis: analysis
        })

      if (insertError) {
        console.error('æ•°æ®ä¿å­˜å¤±è´¥:', insertError)
        document.getElementById('save-status').textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'
      } else {
        console.log('ä¿å­˜æˆåŠŸï¼', insertData)
        document.getElementById('save-status').textContent = 'å·²ä¿å­˜åˆ°æ•°æ®åº“'
      }
    }
  </script>
</body>
</html>
